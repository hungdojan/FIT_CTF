# syntax=docker/dockerfile:1
FROM docker.io/library/ubuntu:jammy

# unminimize
RUN yes | unminimize

# install sshd and ssh
RUN apt-get update -y \
    && apt-get install openssh-server openssh -y \
    && /usr/bin/ssh-keygen -A

# config sshd
RUN mkdir /var/run/sshd \
    && sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd \
    && useradd user \
    && chsh -s /bin/bash user

# copy and run the initialization shell script
COPY ./init_script.sh /tmp/init_script.sh

# install other utils
RUN bash /tmp/init_script.sh \
    && apt-get clean \
    && rm -rf /var/cache/apt/lists \
    && rm /tmp/init_script.sh


# expose ssh port
EXPOSE 22

# run default command
CMD ["/usr/sbin/sshd", "-D"]
